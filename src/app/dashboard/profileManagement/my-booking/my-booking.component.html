<ngx-spinner bdColor="#fff" size="medium" color="#fff">
  <p style="font-size: 20px; color: white" class="loaderbg">
    <img src="assets/img/favicon.jpg" class="loader-logo" width="100" />
  </p>
</ngx-spinner>

<h4 class="mb-3">My Bookings</h4>
<div *ngIf="(bookingList && bookingList.length > 0); then booking; else noData"></div>
<ng-template #booking>
  <div class="table-responsive mb-3">
    <table class="table table-hover bookingtable" *ngIf="this.roles === 'U'">
      <thead>
        <tr>
          <th>
            Doctor Info
          </th>
          <th>
            Date/Slot
          </th>
          <th class="note">
            Notes
          </th>
          <th class="status">
            Status
          </th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let book of bookingList | paginate: { id: 'booking',
        itemsPerPage: itemsPerPage,
        currentPage: currentPage,
        totalItems: totalItems 
        }"
        [ngClass]="{'bg-lightgrey': !(book.drId)}"
        >
          <td>
            <span *ngIf="book.drId; then drName; else noDrName;"></span>
            <ng-template #drName>
              {{ book.drId.firstName }} - {{ book.drId.lastName }}<br>
              {{ book.drId.email }}              
            </ng-template>
            <ng-template #noDrName>
              This doctor is no longer available.
            </ng-template>
          </td>
          <td>
            <span class="text-nowrap">{{ book.bookingDateTime | date: 'MMM d, y, HH: mm'}}</span> 
            <!-- - {{ book.timing }} -->
          </td>
          <td>
            {{ book.note }}
          </td>
          <td>
            <div *ngIf="book.rating === 0">
              <div class="d-block" [ngSwitch]="book.status">
                <div *ngSwitchCase="0" class="text-success">
                  <h6>Pending</h6>
                  
                </div>
                <div *ngSwitchCase="1" class="text-success">
                  <i class="fa fa-check"></i> Approved
                </div>
                <div *ngSwitchCase="2" class="text-danger">
                  <i class="fa fa-times"></i> Rejected
                </div>
                <div *ngSwitchCase="3" class="text-danger">
                  <i class="fa fa-ban"></i> Canceled
                </div>
                <div *ngSwitchCase="4" class="text-success">
                  <button
                    *ngIf="!book.rating"
                    (click)="showReviewModal(book)"
                    id ="reviewButton"
                    class="btn btn-success"
                  >Rate Now</button>
  
                </div>
  
                <div *ngSwitchCase="5" class="text-success">
                  <button
                    (click)="updateBooking(book._id, 1)"
                    class="btn btn-primary mr-1"
                  >
                    Accept
                  </button>
                  <button
                    (click)="updateBooking(book._id, 2)"
                    class="btn btn-error mr-1"
                  >
                    Reject
                  </button>
                  <!-- <button
                    class="btn btn-success"
                    data-toggle="modal"
                    data-target="#reviewModal"
                  >
                    Completed
                  </button> -->
                </div>
                <div *ngSwitchCase="6" class="text-success">
                  
                  <i class="fa fa-check"></i> Accepted
                </div>
                <div *ngSwitchDefault></div>
              </div>
            </div>
            <div *ngIf="book.rating !== 0">
              <div class="text-review mb-2" *ngIf="book.rating">
                <div class="text-rating mb-2" *ngIf="book.rating === 5">
                  <i class="fa fa-star"></i>
                  <i class="fa fa-star"></i>
                  <i class="fa fa-star"></i>
                  <i class="fa fa-star"></i>
                  <i class="fa fa-star"></i>
                </div>
                <div class="text-rating mb-2" *ngIf="book.rating === 4">
                  <i class="fa fa-star"></i>
                  <i class="fa fa-star"></i>
                  <i class="fa fa-star"></i>
                  <i class="fa fa-star"></i>
                  <i class="far fa-star"></i>
                </div>
                <div class="text-rating mb-2" *ngIf="book.rating === 3">
                  <i class="fa fa-star"></i>
                  <i class="fa fa-star"></i>
                  <i class="fa fa-star"></i>
                  <i class="far fa-star"></i>
                  <i class="far fa-star"></i>
                </div>
                <div class="text-rating mb-2" *ngIf="book.rating === 2">
                  <i class="fa fa-star"></i>
                  <i class="fa fa-star"></i>
                  <i class="far fa-star"></i>
                  <i class="far fa-star"></i>
                  <i class="far fa-star"></i>
                </div>
                <div class="text-rating mb-2" *ngIf="book.rating === 1">
                  <i class="fa fa-star"></i>
                  <i class="far fa-star"></i>
                  <i class="far fa-star"></i>
                  <i class="far fa-star"></i>
                  <i class="far fa-star"></i>
                </div>
              </div>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
    <table
      class="table table-hover bookingtable w-100"
      *ngIf="this.roles === 'C' || this.roles === 'SP'"
    >
      <thead>
        <tr>
          <th>
            Patient's Info
          </th>
          <th>
            Date/Slot
          </th>
          <th>
            Doctor's Info
          </th>
          <th class="Reschedule"  style="text-align: center;">
            Actions
          </th>
        </tr>
      </thead>
      <tbody>
        <tr
          *ngFor="let book of bookingList | paginate: { id: 'booking',
          itemsPerPage: itemsPerPage,
          currentPage: currentPage,
          totalItems: totalItems 
          }"
          [ngClass]="{ disabled: book.status === 2, 'bg-lightgrey': !book.drId }"
          >
          <td>
            <p>{{ book.name }}</p>
            {{ book.phone }} / {{ book.email }}
          </td>
          <td>
            <span class="text-nowrap">{{ book.bookingDateTime | date: 'MMM d, y, HH: mm'}}</span>
             <!-- - {{ book.timing }} -->
          </td>
          <td>
            <span *ngIf="book.drId; then drName; else noDrName;"></span>
            <ng-template #drName>
              {{ book.drId.firstName }} - {{ book.drId.lastName }}<br>
              {{ book.drId.email }}              
            </ng-template>
            <ng-template #noDrName>
              This doctor is no longer available.
            </ng-template>
          </td>
          <td class="text-nowrap" style="text-align: center;">
            <div class="d-block" [ngSwitch]="book.status">
              <div *ngSwitchCase="0">
                <button
                  (click)="updateBooking(book._id, 1)"
                  class="btn btn-primary mr-1"
                >
                  Accept
                </button>
                <button
                  (click)="updateBooking(book._id, 2)"
                  class="btn btn-error mr-1"
                >
                  Reject
                </button>
                <button
                  (click)="rescheduleBooking(book)"
                  class="btn btn-success"
                >
                  Reschedule
                </button>
              </div>
              <div *ngSwitchCase="1">
                <span class="text-success">
                  Approved
                </span>
                <button
                  (click)="updateBooking(book._id, 4)"
                  class="btn btn-primary ml-2"
                >
                  Completed
                </button>
                
  
              </div>
              <div *ngSwitchCase="2">Rejected</div>
              <div *ngSwitchCase="3" class="text-danger">
                <i class="fa fa-times"></i> Canceled
              </div>
              <div *ngSwitchCase="4" class="text-primary">
                <i class="fa fa-check"></i> Completed
              </div>
              <div *ngSwitchCase="5" class="text-primary">
                Waiting for Acceptance
              </div>
              <div *ngSwitchDefault></div>
            </div>
          </td>
        </tr>
      </tbody>
    </table>  
  </div>
  <div class="text-center paginator" *ngIf="totalItems > itemsPerPage">
    <pagination-controls id="booking" (pageChange)="changePage($event)"></pagination-controls>
  </div>
</ng-template>


<ng-template #noData>
  <h5>No Booking done...</h5>
  <button *ngIf="this.roles === 'U'"  type="button" class="btn btn-primary" [routerLink]="['/practitioners']">Book Now</button>
</ng-template>

<modal
id="booking-reschedule"
[bodyStyle]="{'padding-bottom': 0, 'max-width': '650px'}"
#modalBookingReschedule
>
  <div class="title-container d-flex justify-content-between align-items-center">
    <span class="h5 h4-md mr-3 mb-0 flex-grow-1">Reschedule appointment</span>
    <button class="btn pr-0 btn-icon" (click)="modalBookingReschedule.hide()">
      <i iconPh="cross"></i>
    </button>  
  </div>

  <div class="content-container">
    <form (ngSubmit)="onSubmitBookingReschedule()">

      <div class="mb-10p">
        <label class="subtitle1">
          Date & Time
          <span class="text-danger">*</span>
        </label>
        <form-item-datetime 
        label="Date & time"
        [controller]="f.bookingDateTime" 
        [submitted]="submitted"
        [minDateTime]="minDateTime"
        ></form-item-datetime>
      </div>

      <div class="text-right sticky-bottom blur pt-10p pb-50p">
        <button 
        type="submit" 
        class="btn btn-primary" 
        [disabled]="isBookingRescheduleLoading"
        >Update</button>
      </div>
    </form>
  </div>
</modal>

<modal
id="booking-rating"
[bodyStyle]="{'padding-bottom': 0, 'max-width': '650px'}"
#modalBookingRating
>
  <div class="title-container d-flex justify-content-between align-items-center">
    <span class="h5 h4-md mr-3 mb-0 flex-grow-1">Rate your experience</span>
    <button class="btn pr-0 btn-icon" (click)="modalBookingRating.hide()">
      <i iconPh="cross"></i>
    </button>  
  </div>

  <div class="content-container">
    <form (ngSubmit)="submitRating()">
      <div class="mt-3">
        <label class="subtitle2">Overall Experience</label>
        <app-ratings [rating]='0'  (ratingClick)='ratingComponentClick($event)'></app-ratings>
      </div>

      <small *ngIf="ratingSubmited && !ratingClicked" class="text-danger col-sm-12">
        Rating is required
      </small>

      <div class="subtitle2 mb-3">
        Your Review
      </div>
      <textarea
        class="form-control"
        [(ngModel)] = "review"
        [ngModelOptions]="{standalone: true}"
        placeholder="Write a review..."
      ></textarea>
      <div class="text-right sticky-bottom blur pt-10p pb-50p">
        <button 
        type="submit" 
        class="btn btn-primary" 
        [disabled]="isBookingRatingLoading"
        >Update</button>
      </div>
    </form>
  </div>
</modal>

